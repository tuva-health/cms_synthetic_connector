#######  DuckDB/MotherDuck
  duckdb_clinical_and_claims_enabled:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt-core and DuckDB adapter
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==1.10.15 dbt-duckdb

      - name: Create dbt profile for DuckDB/MotherDuck
        env:
          MOTHERDUCK_TOKEN: ${{ secrets.DBT_MOTHERDUCK_TOKEN }}
          DBT_PROJECT_DIR: "." 
        run: |
          mkdir -p ./integration_tests/duckdb
          python3 << 'EOF'
          import os
          import yaml
          
          # Create unique database name for CI run
          db_name = "my_db"
          
          # Build the MotherDuck connection string
          motherduck_path = f"md:{db_name}?motherduck_token={os.environ['MOTHERDUCK_TOKEN']}"
          
          profile = {
              'default': {
                  'outputs': {
                      'dev': {
                          'type': 'duckdb',
                          'path': motherduck_path,
                          'threads': 4,
                          'settings': {
                              'custom_user_agent': 'dbt-ci'
                          }
                      }
                  },
                  'target': 'dev'
              }
          }
          
          with open('./integration_tests/duckdb/profiles.yml', 'w') as f:
              yaml.dump(profile, f, default_flow_style=False)
          
          print(f"Created DuckDB/MotherDuck profile with database: {db_name}")
          EOF
        working-directory: ${{ env.DBT_PROJECT_DIR }}

      - name: dbt-deps
        run: dbt deps --profiles-dir ./integration_tests/profiles/duckdb
        working-directory: ${{ env.DBT_PROJECT_DIR }}

      - name: dbt-debug
        run: dbt debug --profiles-dir ./integration_tests/profiles/duckdb
        working-directory: ${{ env.DBT_PROJECT_DIR }}

      - name: dbt-build
        run: |
          dbt build --full-refresh --profiles-dir ./integration_tests/profiles/duckdb \
            --vars '{"use_synthetic_data": true,"clinical_enabled": true,"claims_enabled": true,"provider_attribution_enabled":true,"fhir_preprocessing_enabled":true}'
        working-directory: ${{ env.DBT_PROJECT_DIR }}

      - name: Get the result
        if: ${{ always() }}
        run: echo "${{ steps.dbt-build.outputs.result }}"
        shell: bash